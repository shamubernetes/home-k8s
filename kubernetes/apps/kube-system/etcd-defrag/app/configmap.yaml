---
apiVersion: v1
kind: ConfigMap
metadata:
  name: etcd-defrag-script
data:
  defrag.sh: |
    #!/bin/sh
    set -eu

    # etcd Defragmentation Script for Talos Linux
    # Discovers nodes and Talos version dynamically
    # Exits with error if it cannot properly check etcd status

    # Configuration
    FRAG_THRESHOLD=35  # Defrag if fragmentation exceeds this percentage

    echo "=========================================="
    echo "etcd Fragmentation Check & Defrag Script"
    echo "=========================================="
    echo "Start time: $(date)"
    echo "Fragmentation threshold: $FRAG_THRESHOLD%"
    echo ""

    # Install required tools
    echo "Installing required tools..."
    apk add --no-cache curl jq >/dev/null 2>&1
    echo ""

    # Build talosconfig from certificate components
    echo "Building talosconfig from certificate components..."

    SECRETS_DIR="/var/run/secrets/talos"
    if [ ! -f "$SECRETS_DIR/ca" ] || [ ! -f "$SECRETS_DIR/crt" ] || [ ! -f "$SECRETS_DIR/key" ]; then
        echo "ERROR: Required certificate files not found in $SECRETS_DIR"
        exit 1
    fi

    # Get control plane node IPs from Kubernetes API
    echo "Discovering control plane nodes..."
    KUBE_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
    KUBE_CA=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    KUBE_API="https://kubernetes.default.svc"

    # Get nodes with control-plane role using curl
    NODES_JSON=$(curl -sS --cacert "$KUBE_CA" \
        -H "Authorization: Bearer $KUBE_TOKEN" \
        "$KUBE_API/api/v1/nodes?labelSelector=node-role.kubernetes.io/control-plane")

    CONTROL_PLANE_NODES=$(echo "$NODES_JSON" | jq -r '.items[] | "\(.status.addresses[] | select(.type=="InternalIP") | .address):\(.metadata.name)"')

    if [ -z "$CONTROL_PLANE_NODES" ]; then
        echo "ERROR: No control plane nodes found"
        exit 1
    fi

    # Get first node IP for initial talosctl commands
    FIRST_NODE_IP=$(echo "$CONTROL_PLANE_NODES" | head -1 | cut -d: -f1)
    echo "Found control plane nodes:"
    echo "$CONTROL_PLANE_NODES" | while read -r line; do
        NODE_IP=$(echo "$line" | cut -d: -f1)
        NODE_NAME=$(echo "$line" | cut -d: -f2)
        echo "  - $NODE_NAME ($NODE_IP)"
    done
    echo ""

    # Create talosconfig
    export TALOSCONFIG="/tmp/talosconfig"
    CA_DATA=$(cat "$SECRETS_DIR/ca")
    CRT_DATA=$(cat "$SECRETS_DIR/crt")
    KEY_DATA=$(cat "$SECRETS_DIR/key")

    # Build talosconfig YAML properly
    {
        echo "context: kubernetes"
        echo "contexts:"
        echo "  kubernetes:"
        echo "    endpoints:"
        for node in $CONTROL_PLANE_NODES; do
            NODE_IP=$(echo "$node" | cut -d: -f1)
            echo "      - $NODE_IP"
        done
        echo "    ca: $CA_DATA"
        echo "    crt: $CRT_DATA"
        echo "    key: $KEY_DATA"
    } > "$TALOSCONFIG"

    echo "Talosconfig created"
    echo ""

    # Download talosctl
    echo "Downloading talosctl..."
    curl -sLo /usr/local/bin/talosctl https://github.com/siderolabs/talos/releases/latest/download/talosctl-linux-amd64
    chmod +x /usr/local/bin/talosctl

    # Test connection - FAIL if we can't connect
    echo "Testing connection to cluster..."
    if ! talosctl -n "$FIRST_NODE_IP" version --short; then
        echo "ERROR: Failed to connect to Talos API on $FIRST_NODE_IP"
        echo "Please check talosconfig credentials are correct"
        exit 1
    fi

    # Get and install matching Talos version
    TALOS_VERSION=$(talosctl -n "$FIRST_NODE_IP" version --short 2>/dev/null | grep "Tag:" | head -1 | awk '{print $2}')
    if [ -n "$TALOS_VERSION" ]; then
        echo "Detected Talos version: $TALOS_VERSION"
        echo "Downloading matching talosctl $TALOS_VERSION..."
        curl -sLo /usr/local/bin/talosctl "https://github.com/siderolabs/talos/releases/download/$TALOS_VERSION/talosctl-linux-amd64"
        chmod +x /usr/local/bin/talosctl
    fi
    echo ""

    # Function to get fragmentation percentage for a node
    # Returns empty string on failure (caller must handle)
    get_fragmentation() {
        NODE="$1"
        STATUS=$(talosctl -n "$NODE" etcd status 2>&1) || {
            echo "ERROR: Failed to get etcd status from $NODE" >&2
            echo "$STATUS" >&2
            return 1
        }

        if [ -z "$STATUS" ]; then
            echo "ERROR: Empty response from etcd status on $NODE" >&2
            return 1
        fi

        # Extract the percentage from the IN USE column (e.g., "29.62" from "(29.62%)")
        IN_USE_PCT=$(echo "$STATUS" | grep -v "^NODE" | grep -oE '\([0-9.]+%\)' | tr -d '()%')

        if [ -z "$IN_USE_PCT" ]; then
            echo "ERROR: Could not parse IN USE percentage from etcd status on $NODE" >&2
            echo "Raw output:" >&2
            echo "$STATUS" >&2
            return 1
        fi

        # Fragmentation = 100 - in_use_percentage
        FRAG=$(awk "BEGIN {printf \"%.0f\", 100 - $IN_USE_PCT}")
        echo "$FRAG"
    }

    # Function to defrag a single node
    defrag_node() {
        NODE="$1"
        NODE_NAME="$2"
        echo "----------------------------------------"
        echo "Defragmenting $NODE_NAME ($NODE)..."
        echo "----------------------------------------"
        if talosctl -n "$NODE" etcd defrag; then
            echo "Defragmentation completed successfully"
        else
            echo "Defragmentation failed on $NODE_NAME"
            return 1
        fi
        echo ""
    }

    # Check fragmentation on all nodes
    echo "Checking fragmentation levels..."
    echo ""

    FAILED=false
    for node in $CONTROL_PLANE_NODES; do
        NODE_IP=$(echo "$node" | cut -d: -f1)
        NODE_NAME=$(echo "$node" | cut -d: -f2)

        FRAG=$(get_fragmentation "$NODE_IP") || {
            echo "ERROR: Failed to get fragmentation for $NODE_NAME ($NODE_IP)"
            FAILED=true
            continue
        }

        echo "$NODE_NAME ($NODE_IP): $FRAG% fragmentation"

        if [ "$FRAG" -gt "$FRAG_THRESHOLD" ] 2>/dev/null; then
            touch /tmp/needs_defrag
        fi
    done

    # Fail if we couldn't check any node
    if [ "$FAILED" = "true" ]; then
        echo ""
        echo "ERROR: Failed to check fragmentation on one or more nodes"
        exit 1
    fi

    echo ""
    echo "Threshold: $FRAG_THRESHOLD%"
    echo ""

    if [ -f /tmp/needs_defrag ]; then
        echo "=========================================="
        echo "Fragmentation exceeds threshold - DEFRAGMENTING"
        echo "=========================================="
        echo ""

        echo "Current etcd status:"
        talosctl -n "$FIRST_NODE_IP" etcd status || true
        echo ""

        # Defragment each node sequentially
        DEFRAG_FAILED=false
        for node in $CONTROL_PLANE_NODES; do
            NODE_IP=$(echo "$node" | cut -d: -f1)
            NODE_NAME=$(echo "$node" | cut -d: -f2)
            if ! defrag_node "$NODE_IP" "$NODE_NAME"; then
                DEFRAG_FAILED=true
            fi
            echo "Waiting 10 seconds before next node..."
            sleep 10
        done

        if [ "$DEFRAG_FAILED" = "true" ]; then
            echo "ERROR: Defragmentation failed on one or more nodes"
            exit 1
        fi

        echo "=========================================="
        echo "Defragmentation Complete!"
        echo "=========================================="

        echo ""
        echo "Final etcd status:"
        talosctl -n "$FIRST_NODE_IP" etcd status || true

        rm -f /tmp/needs_defrag
    else
        echo "=========================================="
        echo "Fragmentation within limits - NO ACTION NEEDED"
        echo "=========================================="
    fi

    echo ""
    echo "End time: $(date)"
