---
apiVersion: v1
kind: ConfigMap
metadata:
  name: n8n-credential-seeder
data:
  seed-credentials.sh: |
    #!/bin/sh
    set -e

    # Wait for n8n to be ready
    echo "Waiting for n8n to be ready..."
    until wget -q -O /dev/null http://localhost:5678/healthz 2>/dev/null; do
      sleep 2
    done
    echo "n8n is ready"

    # Configuration
    N8N_API_URL="http://localhost:5678/api/v1"
    OP_CONNECT_URL="http://onepassword-connect.op.svc.cluster.local:8080"

    # Check if a credential exists by name
    credential_exists() {
      local name="$$1"
      wget -q -O- --header="X-N8N-API-KEY: $$N8N_API_KEY" \
        "$$N8N_API_URL/credentials" 2>/dev/null | \
        grep -q "\"name\":\"$$name\""
    }

    # Create 1Password Connect credential
    create_op_credential() {
      echo "Creating 1Password Connect credential..."
      wget -q -O- --header="X-N8N-API-KEY: $$N8N_API_KEY" \
        --header="Content-Type: application/json" \
        --post-data="{
          \"name\": \"1Password Connect\",
          \"type\": \"onePasswordApi\",
          \"data\": {
            \"token\": \"$$OP_CONNECT_TOKEN\",
            \"baseURL\": \"$$OP_CONNECT_URL\",
            \"allowedDomains\": \"*\"
          }
        }" \
        "$$N8N_API_URL/credentials" >/dev/null
      echo "Created 1Password Connect credential"
    }

    # Fetch a field from 1Password
    op_get_field() {
      local vault_id="$$1"
      local item_id="$$2"
      local field_label="$$3"
      wget -q -O- --header="Authorization: Bearer $$OP_CONNECT_TOKEN" \
        "$$OP_CONNECT_URL/v1/vaults/$$vault_id/items/$$item_id" 2>/dev/null | \
        sed -n "s/.*\"label\":\"$$field_label\"[^}]*\"value\":\"\([^\"]*\)\".*/\1/p"
    }

    # Create Postgres credential
    create_postgres_credential() {
      echo "Fetching Postgres credentials from 1Password..."
      local pg_user=$$(op_get_field "$$OP_VAULT_KUBERNETES" "$$OP_ITEM_N8N" "N8N_POSTGRES_USER")
      local pg_pass=$$(op_get_field "$$OP_VAULT_KUBERNETES" "$$OP_ITEM_N8N" "N8N_POSTGRES_PASS")

      echo "Creating Postgres credential..."
      wget -q -O- --header="X-N8N-API-KEY: $$N8N_API_KEY" \
        --header="Content-Type: application/json" \
        --post-data="{
          \"name\": \"Postgres account\",
          \"type\": \"postgres\",
          \"data\": {
            \"host\": \"postgres17-pooler-session.database.svc.cluster.local\",
            \"port\": 5432,
            \"database\": \"n8n\",
            \"user\": \"$$pg_user\",
            \"password\": \"$$pg_pass\",
            \"ssl\": \"disable\"
          }
        }" \
        "$$N8N_API_URL/credentials" >/dev/null
      echo "Created Postgres credential"
    }

    # Main
    echo "Starting credential seeder..."

    # 1Password Connect credential
    if credential_exists "1Password Connect"; then
      echo "1Password Connect credential already exists, skipping"
    else
      create_op_credential
    fi

    # Postgres credential
    if credential_exists "Postgres account"; then
      echo "Postgres account credential already exists, skipping"
    else
      create_postgres_credential
    fi

    echo "Credential seeding complete!"
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: n8n-seeder-secrets
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: op-secret-store
  target:
    name: n8n-seeder-secrets
    creationPolicy: Owner
  data:
    - secretKey: N8N_API_KEY
      remoteRef:
        conversionStrategy: Default
        key: n8n API Key
        property: api_key
    - secretKey: OP_CONNECT_TOKEN
      remoteRef:
        conversionStrategy: Default
        key: 1Password Connect
        property: credential
