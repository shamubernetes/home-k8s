---
apiVersion: v1
kind: ConfigMap
metadata:
  name: etcd-defrag-script
data:
  defrag.sh: |
    #!/bin/sh
    set -eu

    # etcd Defragmentation Script for Talos Linux
    # Discovers nodes and Talos version dynamically

    # Configuration
    FRAG_THRESHOLD=35  # Defrag if fragmentation exceeds this percentage

    echo "=========================================="
    echo "etcd Fragmentation Check & Defrag Script"
    echo "=========================================="
    echo "Start time: $(date)"
    echo "Fragmentation threshold: $FRAG_THRESHOLD%"
    echo ""

    # Install required tools
    echo "Installing required tools..."
    apk add --no-cache curl jq >/dev/null 2>&1
    echo ""

    # Build talosconfig from certificate components
    echo "Building talosconfig from certificate components..."

    SECRETS_DIR="/var/run/secrets/talos"
    if [ ! -f "$SECRETS_DIR/ca" ] || [ ! -f "$SECRETS_DIR/crt" ] || [ ! -f "$SECRETS_DIR/key" ]; then
        echo "ERROR: Required certificate files not found in $SECRETS_DIR"
        exit 1
    fi

    # Get control plane node IPs from Kubernetes API
    echo "Discovering control plane nodes..."
    KUBE_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
    KUBE_CA=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    KUBE_API="https://kubernetes.default.svc"

    # Get nodes with control-plane role using curl
    NODES_JSON=$(curl -sS --cacert "$KUBE_CA" \
        -H "Authorization: Bearer $KUBE_TOKEN" \
        "$KUBE_API/api/v1/nodes?labelSelector=node-role.kubernetes.io/control-plane")

    CONTROL_PLANE_NODES=$(echo "$NODES_JSON" | jq -r '.items[] | "\(.status.addresses[] | select(.type=="InternalIP") | .address):\(.metadata.name)"')

    if [ -z "$CONTROL_PLANE_NODES" ]; then
        echo "ERROR: No control plane nodes found"
        exit 1
    fi

    # Get first node IP for initial talosctl commands
    FIRST_NODE_IP=$(echo "$CONTROL_PLANE_NODES" | head -1 | cut -d: -f1)
    echo "Found control plane nodes:"
    echo "$CONTROL_PLANE_NODES" | while read -r line; do
        NODE_IP=$(echo "$line" | cut -d: -f1)
        NODE_NAME=$(echo "$line" | cut -d: -f2)
        echo "  - $NODE_NAME ($NODE_IP)"
    done
    echo ""

    # Create talosconfig
    export TALOSCONFIG="/tmp/talosconfig"
    CA_DATA=$(cat "$SECRETS_DIR/ca")
    CRT_DATA=$(cat "$SECRETS_DIR/crt")
    KEY_DATA=$(cat "$SECRETS_DIR/key")

    # Build endpoints list for talosconfig
    ENDPOINTS_YAML=""
    for node in $CONTROL_PLANE_NODES; do
        NODE_IP=$(echo "$node" | cut -d: -f1)
        ENDPOINTS_YAML="$ENDPOINTS_YAML      - $NODE_IP
    "
    done

    cat > "$TALOSCONFIG" << TALOSEOF
    context: kubernetes
    contexts:
      kubernetes:
        endpoints:
    $ENDPOINTS_YAML      ca: $CA_DATA
        crt: $CRT_DATA
        key: $KEY_DATA
    TALOSEOF

    echo "Talosconfig created"
    echo ""

    # Get Talos version from cluster and install matching talosctl
    echo "Detecting Talos version from cluster..."

    # Download a bootstrap talosctl to query the cluster
    curl -sLo /usr/local/bin/talosctl https://github.com/siderolabs/talos/releases/latest/download/talosctl-linux-amd64
    chmod +x /usr/local/bin/talosctl

    # Get the actual Talos version running on the cluster
    TALOS_VERSION=$(talosctl -n "$FIRST_NODE_IP" version --short 2>/dev/null | grep "Tag:" | head -1 | awk '{print $2}')

    if [ -z "$TALOS_VERSION" ]; then
        echo "WARNING: Could not detect Talos version, using latest talosctl"
    else
        echo "Detected Talos version: $TALOS_VERSION"
        echo "Downloading talosctl $TALOS_VERSION..."
        curl -sLo /usr/local/bin/talosctl "https://github.com/siderolabs/talos/releases/download/$TALOS_VERSION/talosctl-linux-amd64"
        chmod +x /usr/local/bin/talosctl
    fi
    echo ""

    # Function to get fragmentation percentage for a node
    get_fragmentation() {
        NODE="$1"
        STATUS=$(talosctl -n "$NODE" etcd status 2>/dev/null || echo "")
        if [ -z "$STATUS" ]; then
            echo "0"
            return
        fi
        IN_USE_PCT=$(echo "$STATUS" | tail -1 | grep -oE '\([0-9.]+%\)' | tr -d '()%')
        if [ -n "$IN_USE_PCT" ]; then
            FRAG=$(awk "BEGIN {printf \"%.0f\", 100 - $IN_USE_PCT}")
            echo "$FRAG"
        else
            echo "0"
        fi
    }

    # Function to defrag a single node
    defrag_node() {
        NODE="$1"
        NODE_NAME="$2"
        echo "----------------------------------------"
        echo "Defragmenting $NODE_NAME ($NODE)..."
        echo "----------------------------------------"
        if talosctl -n "$NODE" etcd defrag; then
            echo "Defragmentation completed successfully"
        else
            echo "Defragmentation failed on $NODE_NAME"
            return 1
        fi
        echo ""
    }

    # Check fragmentation on all nodes
    echo "Checking fragmentation levels..."
    echo ""

    # Check if any node needs defrag
    for node in $CONTROL_PLANE_NODES; do
        NODE_IP=$(echo "$node" | cut -d: -f1)
        NODE_NAME=$(echo "$node" | cut -d: -f2)
        FRAG=$(get_fragmentation "$NODE_IP")
        echo "$NODE_NAME ($NODE_IP): $FRAG% fragmentation"
        if [ "$FRAG" -gt "$FRAG_THRESHOLD" ] 2>/dev/null; then
            touch /tmp/needs_defrag
        fi
    done

    echo ""
    echo "Threshold: $FRAG_THRESHOLD%"
    echo ""

    if [ -f /tmp/needs_defrag ]; then
        echo "=========================================="
        echo "Fragmentation exceeds threshold - DEFRAGMENTING"
        echo "=========================================="
        echo ""

        echo "Current etcd status:"
        talosctl -n "$FIRST_NODE_IP" etcd status || true
        echo ""

        # Defragment each node sequentially
        for node in $CONTROL_PLANE_NODES; do
            NODE_IP=$(echo "$node" | cut -d: -f1)
            NODE_NAME=$(echo "$node" | cut -d: -f2)
            defrag_node "$NODE_IP" "$NODE_NAME"
            echo "Waiting 10 seconds before next node..."
            sleep 10
        done

        echo "=========================================="
        echo "Defragmentation Complete!"
        echo "=========================================="

        echo ""
        echo "Final etcd status:"
        talosctl -n "$FIRST_NODE_IP" etcd status || true

        rm -f /tmp/needs_defrag
    else
        echo "=========================================="
        echo "Fragmentation within limits - NO ACTION NEEDED"
        echo "=========================================="
    fi

    echo ""
    echo "End time: $(date)"
