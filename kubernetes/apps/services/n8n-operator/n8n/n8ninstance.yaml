---
apiVersion: n8n.n8n.io/v1alpha1
kind: N8nInstance
metadata:
  name: n8n
  namespace: services
spec:
  replicas: 1
  deploymentStrategy: Recreate
  image: docker.io/n8nio/n8n:2.10.2@sha256:cfa50544c4cc172506834da1ec9bb5171db55958c8d1918205df0bda237a56f4
  imagePullPolicy: IfNotPresent
  timezone: "America/New_York"

  initContainers:
    - name: init-db
      image: ghcr.io/home-operations/postgres-init:17.6.0@sha256:86a1992d46273c58fd4ad95b626081dfaabfe16bd56944675169e406d1a660dd
      envFrom:
        - secretRef:
            name: n8n-db-secret

  license:
    activationKeySecretRef:
      name: n8n-license-secret
      key: activation-key

  database:
    type: postgresdb
    secretRef:
      name: n8n-db-secret
    ssl: false
    logging: none

  webhook:
    url: "https://n8n.${HOME_DOMAIN}/"

  smtp:
    enabled: true
    secretRef:
      name: n8n-smtp-secret

  executions:
    mode: regular
    timeout: -1
    saveDataOnError: all
    saveDataOnSuccess: all
    pruneData: true
    pruneDataMaxAge: "336h"

  logging:
    level: info
    output: console

  encryption:
    keySecretRef:
      name: n8n-encryption-secret
      key: N8N_ENCRYPTION_KEY

  # One-time owner bootstrap (skips setup screen)
  ownerSetup:
    secretRef:
      name: n8n-owner-secret

  service:
    type: ClusterIP
    port: 5678

  ingress:
    enabled: true
    className: internal
    host: n8n.${HOME_DOMAIN}
    path: /
    pathType: Prefix
    annotations:
      external-dns.alpha.kubernetes.io/target: internal.${HOME_DOMAIN}

  persistence:
    enabled: true
    size: 5Gi
    storageClass: ceph-block

  metrics:
    enabled: true
    includeWorkflowIdLabel: true
    includeApiEndpoints: true

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 1Gi

  extraEnv:
    - name: GENERIC_TIMEZONE
      value: "America/New_York"
    - name: N8N_HOST
      value: n8n.${HOME_DOMAIN}
    - name: N8N_PROTOCOL
      value: https
    - name: N8N_TRUST_PROXY
      value: "true"
