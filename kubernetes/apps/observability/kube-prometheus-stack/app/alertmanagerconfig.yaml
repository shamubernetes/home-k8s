# yaml-language-server: $schema=https://k8s-schemas.pages.dev/monitoring.coreos.com/alertmanagerconfig_v1alpha1.json
apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: alertmanager
spec:
  route:
    groupBy: ["alertname", "job"]
    groupInterval: 10m
    groupWait: 1m
    receiver: pagerduty
    repeatInterval: 12h
    routes:
    - receiver: "null"
      matchers:
      - name: alertname
        value: InfoInhibitor
        matchType: "="
    - receiver: heartbeat
      groupInterval: 5m
      groupWait: 0s
      repeatInterval: 5m
      matchers:
      - name: alertname
        value: Watchdog
        matchType: "="
    - receiver: "null"
      matchers:
      - name: severity
        value: info
        matchType: "="
  inhibitRules:
  - equal: ["alertname", "namespace"]
    sourceMatch:
    - name: severity
      value: critical
      matchType: "="
    targetMatch:
    - name: severity
      value: warning
      matchType: "="
  receivers:
  - name: "null"
  - name: heartbeat
    webhookConfigs:
    - urlSecret:
        name: &secret alertmanager-secret
        key: ALERTMANAGER_HEARTBEAT_URL
  - name: pagerduty
    pagerdutyConfigs:
    - routingKey:
        name: *secret
        key: PD_ALERTMANAGER_INTEGRATION_KEY
      sendResolved: true
      # Clean title: [STATUS] AlertName (N firing)
      description: >-
        {{ .CommonAnnotations.summary | default .CommonLabels.alertname }}
      # Map severity from alert label, default to warning
      severity: >-
        {{ if eq .CommonLabels.severity "critical" }}critical{{ else if eq .CommonLabels.severity "warning" }}warning{{ else }}error{{ end }}
      # PagerDuty event classification
      class: "{{ .CommonLabels.alertname }}"
      component: "{{ .CommonLabels.namespace | default \"cluster\" }}"
      group: "{{ .CommonLabels.job | default \"prometheus\" }}"
      source: "titans-k8s"
      client: "Alertmanager"
      clientURL: "https://alertmanager.${HOME_DOMAIN}"
      # Structured details instead of raw JSON
      details:
      - key: alertname
        value: "{{ .CommonLabels.alertname }}"
      - key: namespace
        value: "{{ .CommonLabels.namespace }}"
      - key: severity
        value: "{{ .CommonLabels.severity }}"
      - key: description
        value: "{{ .CommonAnnotations.description | default .CommonAnnotations.summary | default \"No description\" }}"
      - key: runbook_url
        value: "{{ .CommonAnnotations.runbook_url | default \"N/A\" }}"
      - key: firing
        value: "{{ .Alerts.Firing | len }}"
      - key: resolved
        value: "{{ .Alerts.Resolved | len }}"
