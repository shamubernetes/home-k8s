{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "packageRules": [
    // Allowed Versions
    {
      "description": "PostgreSQL 17",
      "matchDatasources": ["docker"],
      "matchPackagePatterns": ["postgresql", "postgres-init"],
      "allowedVersions": "<18"
    },
    // Versions
    {
      "description": ["Custom versioning for http-https-echo"],
      "matchDatasources": ["docker"],
      "versioning": "regex:^(?<major>\\d+)$",
      "matchPackagePatterns": ["mendhak/http-https-echo"],
    },
    {
      "description": ["Loose versioning for plex"],
      "matchDatasources": ["docker"],
      "versioning": "loose",
      "matchPackagePatterns": ["plex"]
    },
    // Groups
    {
      "description": ["Actions Runner Controller Group"],
      "groupName": "Actions Runner Controller",
      "matchPackagePatterns": ["gha-runner-scale-set"],
      "matchDatasources": ["docker", "helm"],
      "semanticCommitScope": "group",
      "group": {
        "commitMessageTopic": "{{{groupName}}}"
      },
      "separateMinorPatch": true
    },
    {
      "description": "Cilium image and chart",
      "groupName": "cilium",
      "matchDepNames": [
        "quay.io/cilium/cilium",
        "quay.io/cilium/operator-generic",
        "cilium",
      ],
      "matchDatasources": ["helm", "docker", "helmfile"],
      "semanticCommitScope": "group",
      "group": {
        "commitMessageTopic": "{{{groupName}}}",
      },
      "separateMinorPatch": true,
    },
    {
      "description": ["CoreDNS Group"],
      "groupName": "coredns",
      "matchPackagePatterns": ["coredns"],
      "matchDatasources": ["helm", "docker", "helmfile"],
      "semanticCommitScope": "group",
      "group": {
        "commitMessageTopic": "{{{groupName}}}"
      },
      "separateMinorPatch": true
    },
    {
      "description": ["Kubelet CSR Approver Group"],
      "groupName": "kubelet-csr-approver",
      "matchPackagePatterns": ["kubelet-csr-approver"],
      "matchDatasources": ["helm", "helmfile"],
      "semanticCommitScope": "group",
      "group": {
        "commitMessageTopic": "{{{groupName}}}"
      },
      "separateMinorPatch": true
    },
    {
      "description": ["Dragonfly Operator Group"],
      "groupName": "Dragonfly Operator",
      "matchPackagePatterns": ["dragonfly(?:db)?.operator"],
      "matchDatasources": ["docker", "github-releases"],
      "semanticCommitScope": "group",
      "group": {
        "commitMessageTopic": "{{{groupName}}}"
      },
      "separateMinorPatch": true
    },
    {
      "description": ["Flux Group"],
      "groupName": "Flux",
      "matchPackagePatterns": ["fluxcd"],
      "matchDatasources": ["docker", "github-tags"],
      "semanticCommitScope": "group",
      "versioning": "semver",
      "group": {
        "commitMessageTopic": "{{{groupName}}}"
      },
      "separateMinorPatch": true
    },
    {
      "description": ["Intel Device Plugins Group"],
      "groupName": "Intel-Device-Plugins",
      "matchPackagePatterns": ["intel-device-plugins"],
      "matchDatasources": ["helm"],
      "semanticCommitScope": "group",
      "group": {
        "commitMessageTopic": "{{{groupName}}}"
      },
      "separateMinorPatch": true
    },
    {
      "description": ["Spegel Group"],
      "groupName": "spegel",
      "matchPackagePatterns": ["spegel"],
      "matchDatasources": ["helm", "docker", "helmfile"],
      "semanticCommitScope": "group",
      "group": {
        "commitMessageTopic": "{{{groupName}}}"
      },
      "separateMinorPatch": true
    },
    {
      "description": ["Rook-Ceph Group"],
      "groupName": "Rook-Ceph",
      "matchPackagePatterns": ["rook.ceph"],
      "matchDatasources": ["docker", "helm"],
      "semanticCommitScope": "group",
      "group": {
        "commitMessageTopic": "{{{groupName}}}"
      },
      "separateMinorPatch": true
    },
    {
      "description": ["System Upgrade Controller Group"],
      "groupName": "System Upgrade Controller",
      "matchPackagePatterns": ["system-upgrade-controller"],
      "matchDatasources": ["docker", "github-releases"],
      "semanticCommitScope": "group",
      "group": {
        "commitMessageTopic": "{{{groupName}}}"
      },
      "separateMinorPatch": true
    },
    {
      "description": ["Talos Group"],
      "groupName": "Talos",
      "matchPackagePatterns": [
        "siderolabs/talosctl",
        "siderolabs/installer"
      ],
      "matchDatasources": ["docker"],
      "semanticCommitScope": "group",
      "group": {
        "commitMessageTopic": "{{{groupName}}}"
      },
      "separateMinorPatch": true
    },
    {
      "description": "Thanos Group - mismatched versions",
      "groupName": "Thanos",
      "matchPackagePatterns": ["thanos"],
      "matchDatasources": ["docker", "github-releases", "helm"],
      "semanticCommitScope": "group",
      "group": {
        "commitMessageTopic": "{{{groupName}}}",
      },
      "separateMinorPatch": false,
    },
    {
      "description": "Vector Group - mismatched versions",
      "groupName": "Vector",
      "matchPackagePatterns": ["vector"],
      "matchDatasources": ["docker", "github-releases", "helm"],
      "semanticCommitScope": "group",
      "group": {
        "commitMessageTopic": "{{{groupName}}}",
      },
      "separateMinorPatch": false,
    },
    // Auto merge
    {
      "description": "Auto-merge Pins",
      "matchUpdateTypes": ["pin", "pinDigest"],
      "automerge": true,
      "automergeType": "pr",
      "assigneesFromCodeOwners": false,
      "ignoreTests": true,
    },
    {
      "description": "Auto-merge all patch updates",
      "matchUpdateTypes": ["patch"],
      "automerge": true,
      "automergeType": "pr",
      "assigneesFromCodeOwners": false,
    },
    {
      "description": "Auto-merge minor updates with 6 hours stability",
      "matchUpdateTypes": ["minor"],
      "matchDatasources": ["helm", "helmfile"],
      "minimumReleaseAge": "6 hours",
      "automerge": true,
      "automergeType": "pr",
      "assigneesFromCodeOwners": false,
    },
    {
      "description": "Auto-merge minor Docker updates (no minimumReleaseAge due to missing registry timestamps)",
      "matchUpdateTypes": ["minor", "patch", "digest"],
      "matchDatasources": ["docker"],
      "automerge": true,
      "automergeType": "pr",
      "assigneesFromCodeOwners": false,
    },
    {
      "matchDatasources": ["custom.grafana-dashboards"],
      "automerge": true,
      "automergeType": "pr",
      "assigneesFromCodeOwners": false,
      "matchUpdateTypes": ["major"],
      "ignoreTests": true
    },
    {
      "description": "Auto merge KPS minors and digests",
      "matchDatasources": ["helm", "docker"],
      "automerge": true,
      "automergeType": "pr",
      "assigneesFromCodeOwners": false,
      "matchUpdateTypes": ["minor", "digest"],
      "matchPackagePatterns": ["kube-prometheus-stack"],
    },
    {
      "description": "Auto merge mise tool updates",
      "matchManagers": ["mise"],
      "automerge": true,
      "automergeType": "pr",
      "assigneesFromCodeOwners": false,
      "matchUpdateTypes": ["minor", "patch"],
    },
    // Schedules for critical infrastructure
    {
      "description": "Talos and Kubernetes upgrades only on 2nd Saturday of month (2-6am)",
      "matchDepNames": [
        "ghcr.io/siderolabs/installer",
        "ghcr.io/siderolabs/kubelet"
      ],
      "matchDatasources": ["docker"],
      "schedule": ["* 2-5 8-14 * 6"]
    },
    {
      "description": "Wait 3 days before updating critical infrastructure",
      "matchPackagePatterns": ["cilium", "rook.ceph"],
      "minimumReleaseAge": "3 days"
    },
  ],
}
