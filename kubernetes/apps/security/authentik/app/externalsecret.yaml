# yaml-language-server: $schema=https://k8s-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
#
# 1Password vault item "authentik" required fields:
#   AUTHENTIK_SECRET_KEY      - Random 50+ char string for session signing (generate with: openssl rand -base64 50)
#   AUTHENTIK_BOOTSTRAP_PASSWORD - Initial admin password
#   AUTHENTIK_BOOTSTRAP_TOKEN    - Initial admin API token (generate with: openssl rand -hex 32)
#   AUTHENTIK_BOOTSTRAP_EMAIL    - Admin email address
#   AUTHENTIK_POSTGRES_USER      - Database username (e.g., authentik)
#   AUTHENTIK_POSTGRES_PASS      - Database password (generate secure password)
#   PLEX_CLIENT_ID               - Any unique identifier (e.g., uuidgen or "authentik-home")
#   PLEX_TOKEN                   - Your Plex token (get from: https://www.plex.tv/claim or browser dev tools)
#                                  This authorizes only users with access to your Plex server
#
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: authentik
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: op-secret-store
  target:
    name: authentik-secret
    template:
      engineVersion: v2
      data:
        # Authentik core settings
        AUTHENTIK_SECRET_KEY: "{{ .AUTHENTIK_SECRET_KEY }}"
        # Bootstrap credentials (used on first startup)
        AUTHENTIK_BOOTSTRAP_PASSWORD: "{{ .AUTHENTIK_BOOTSTRAP_PASSWORD }}"
        AUTHENTIK_BOOTSTRAP_TOKEN: "{{ .AUTHENTIK_BOOTSTRAP_TOKEN }}"
        AUTHENTIK_BOOTSTRAP_EMAIL: "{{ .AUTHENTIK_BOOTSTRAP_EMAIL }}"
        # PostgreSQL configuration
        # Use direct connection (postgres17-rw) instead of pooler because embedded outpost
        # session backend uses search_path which pooler doesn't support
        AUTHENTIK_POSTGRESQL__HOST: postgres17-rw.database.svc.cluster.local
        AUTHENTIK_POSTGRESQL__PORT: "5432"
        AUTHENTIK_POSTGRESQL__NAME: &dbName authentik
        AUTHENTIK_POSTGRESQL__USER: &dbUser "{{ .AUTHENTIK_POSTGRES_USER }}"
        AUTHENTIK_POSTGRESQL__PASSWORD: &dbPass "{{ .AUTHENTIK_POSTGRES_PASS }}"
        # Redis configuration (using Dragonfly)
        AUTHENTIK_REDIS__HOST: dragonfly.database.svc.cluster.local
        AUTHENTIK_REDIS__PORT: "6379"
        # Plex OAuth source configuration
        PLEX_CLIENT_ID: "{{ .PLEX_CLIENT_ID }}"
        PLEX_TOKEN: "{{ .PLEX_TOKEN }}"
        # Database init configuration (for postgres-init container)
        INIT_POSTGRES_DBNAME: *dbName
        INIT_POSTGRES_HOST: postgres17-rw.database.svc.cluster.local
        INIT_POSTGRES_USER: *dbUser
        INIT_POSTGRES_PASS: *dbPass
        INIT_POSTGRES_SUPER_PASS: "{{ .POSTGRES_SUPER_PASS }}"
  dataFrom:
  - extract:
      key: authentik
  - extract:
      key: cloudnative-pg
