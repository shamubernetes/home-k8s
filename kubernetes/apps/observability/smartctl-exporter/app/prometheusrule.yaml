# yaml-language-server: $schema=https://k8s-schemas.pages.dev/monitoring.coreos.com/prometheusrule_v1.json
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: smartctl-exporter-rules
spec:
  groups:
  - name: smartctl-exporter.rules
    rules:
    - alert: SmartDeviceHighTemperature
      annotations:
        summary: Drive {{ $labels.device }} on node {{ $labels.kubernetes_node }} has a temperature higher than 65Â°C.
      expr: smartctl_device_temperature{kubernetes_node!=""} > 65
      for: 15m
      labels:
        severity: critical
    - alert: SmartDeviceTestFailed
      annotations:
        summary: Drive {{ $labels.device }} on node {{ $labels.kubernetes_node }} did not pass its SMART test.
      expr: |
        (
          smartctl_device_smart_status{kubernetes_node!=""} != 1
        or
          smartctl_device_status{kubernetes_node!=""} != 1
        )
      for: 15m
      labels:
        severity: critical
    - alert: SmartDeviceCriticalWarning
      annotations:
        summary: Drive {{ $labels.device }} on node {{ $labels.kubernetes_node }} is in a critical state.
      expr: smartctl_device_critical_warning{kubernetes_node!=""} != 0
      for: 15m
      labels:
        severity: critical
    #
    # Ref: https://github.com/prometheus-community/helm-charts/blob/main/charts/prometheus-smartctl-exporter/rules/rules.txt
    #
    - alert: SmartDeviceMediaErrors
      annotations:
        summary: Drive {{ $labels.device }} on node {{ $labels.kubernetes_node }} has media errors.
      expr: smartctl_device_media_errors{kubernetes_node!=""} != 0
      for: 15m
      labels:
        severity: critical
    - alert: SmartDeviceAvailableSpareUnderThreshold
      annotations:
        summary: Drive {{ $labels.device }} on node {{ $labels.kubernetes_node }} is under available spare threshold.
      expr: |
        smartctl_device_available_spare_threshold{kubernetes_node!=""} > smartctl_device_available_spare{kubernetes_node!=""}
      for: 15m
      labels:
        severity: critical
    - alert: SmartDeviceInterfaceSlow
      annotations:
        summary: Device {{ $labels.device }} on node {{ $labels.kubernetes_node }} interface is slower than it should be.
      expr: |
        smartctl_device_interface_speed{speed_type="current", kubernetes_node!=""} != on(device, instance, namespace, pod, kubernetes_node) smartctl_device_interface_speed{speed_type="max", kubernetes_node!=""}
      for: 15m
      labels:
        severity: critical
