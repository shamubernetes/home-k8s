# yaml-language-server: $schema=https://k8s-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: ${APP}
spec:
  interval: 10m
  timeout: 15m
  chart:
    spec:
      chart: ${APP}
      version: 0.18.0
      sourceRef:
        kind: HelmRepository
        name: ${APP}
        namespace: ${REPO_NAMESPACE}
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    crds: CreateReplace
    remediation:
      strategy: rollback
      retries: 3
  dependsOn:
  - name: kube-prometheus-stack
  values:
    sinksConfig:
    - robusta_sink:
        name: robusta_ui_sink
        token: "{{ env.ROBUSTA_UI_SINK_TOKEN }}"

    # global parameters
    clusterName: "titans"

    globalConfig:
      account_id: "{{ env.ROBUSTA_ACCOUNT_ID }}"
      signing_key: "{{ env.ROBUSTA_SIGNING_KEY }}"

    enablePrometheusStack: false
    argoRollouts: false

    enablePlatformPlaybooks: true

    grafanaRenderer:
      enableContainer: true
    runner:
      additional_env_vars:
      - name: ROBUSTA_UI_SINK_TOKEN
        valueFrom:
          secretKeyRef:
            name: &secret robusta-secret
            key: ROBUSTA_UI_SINK_TOKEN
      - name: ROBUSTA_ACCOUNT_ID
        valueFrom:
          secretKeyRef:
            name: *secret
            key: ROBUSTA_ACCOUNT_ID
      - name: ROBUSTA_SIGNING_KEY
        valueFrom:
          secretKeyRef:
            name: *secret
            key: ROBUSTA_SIGNING_KEY
      sendAdditionalTelemetry: false
