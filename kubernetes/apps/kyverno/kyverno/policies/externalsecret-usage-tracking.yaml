# yaml-language-server: $schema=https://k8s-schemas.pages.dev/kyverno.io/clusterpolicy_v1.json
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: externalsecret-usage-tracking
  annotations:
    policies.kyverno.io/title: Track ExternalSecret usage in 1Password
    policies.kyverno.io/category: Other
    policies.kyverno.io/subject: ExternalSecret
    policies.kyverno.io/description: >-
      Automatically creates PushSecret resources to track which Kustomizations
      are using which 1Password secrets. Adds a tracking field to each referenced
      1Password item indicating the ExternalSecret and Kustomization using it.
spec:
  background: true
  rules:
  - name: generate-usage-tracking-secret
    match:
      any:
      - resources:
          kinds:
          - external-secrets.io/v1/ExternalSecret
    preconditions:
      all:
      - key: "{{request.object.metadata.labels.\"kustomize.toolkit.fluxcd.io/name\" || ''}}"
        operator: NotEquals
        value: ""
    generate:
      generateExisting: true
      apiVersion: v1
      kind: Secret
      name: "{{request.object.metadata.name}}-usage-tracking"
      namespace: "{{request.object.metadata.namespace}}"
      synchronize: true
      data:
        stringData:
          # Value pushed to the secret store for usage tracking.
          # Keep it human-readable.
          tracking-value: "{{ request.object.metadata.namespace }}/{{ request.object.metadata.name }} (kustomization={{ request.object.metadata.labels.\"kustomize.toolkit.fluxcd.io/name\" }})"
  - name: generate-usage-tracking-pushsecret
    match:
      any:
      - resources:
          kinds:
          - external-secrets.io/v1/ExternalSecret
    preconditions:
      all:
      - key: "{{request.object.metadata.labels.\"kustomize.toolkit.fluxcd.io/name\" || ''}}"
        operator: NotEquals
        value: ""
    generate:
      generateExisting: true
      synchronize: true
      foreach:
      - list: "request.object.spec.dataFrom"
        preconditions:
          all:
          - key: "{{ element.extract.key || '' }}"
            operator: NotEquals
            value: ""
        apiVersion: external-secrets.io/v1alpha1
        kind: PushSecret
        name: "{{request.object.metadata.name}}-usage-tracking-{{ element.extract.key }}"
        namespace: "{{request.object.metadata.namespace}}"
        data:
          spec:
            deletionPolicy: Delete
            refreshInterval: 1h0m0s
            secretStoreRefs:
            - name: op-secret-store
              kind: ClusterSecretStore
            selector:
              secret:
                name: "{{request.object.metadata.name}}-usage-tracking"
            data:
            - match:
                secretKey: tracking-value
                remoteRef:
                  remoteKey: "{{ element.extract.key }}"
                  property: notesPlain
