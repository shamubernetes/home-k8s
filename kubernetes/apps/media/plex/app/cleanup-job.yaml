apiVersion: batch/v1
kind: Job
metadata:
  name: plex-media-cleanup
  namespace: media
spec:
  ttlSecondsAfterFinished: 3600
  template:
    spec:
      restartPolicy: Never
      securityContext:
        runAsUser: 568
        runAsGroup: 568
        fsGroup: 568
      containers:
      - name: cleanup
        image: alpine:latest@sha256:25109184c71bdad752c8312a8623239686a9a2071e8825f20acb8f2198c3f659
        command:
        - sh
        - -c
        - |
          echo "Old Media directory size:"
          du -sh /config/Library/Application\ Support/Plex\ Media\ Server/Media || echo "Directory not found or empty"
          echo ""
          echo "Removing old Media directory..."
          rm -rf /config/Library/Application\ Support/Plex\ Media\ Server/Media
          echo "Cleanup complete!"
          echo ""
          echo "Remaining config PVC usage:"
          du -sh /config/Library/Application\ Support/Plex\ Media\ Server
        volumeMounts:
        - name: config
          mountPath: /config/Library/Application Support/Plex Media Server
      volumes:
      - name: config
        persistentVolumeClaim:
          claimName: plex
