# yaml-language-server: $schema=https://k8s-schemas.pages.dev/kyverno.io/clusterpolicy_v1.json
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: externalsecret-usage-tracking
  annotations:
    policies.kyverno.io/title: Track ExternalSecret usage in 1Password
    policies.kyverno.io/category: Other
    policies.kyverno.io/subject: ExternalSecret
    policies.kyverno.io/description: >-
      Automatically creates PushSecret resources to track which Flux Kustomizations
      are using which 1Password secrets.
      Writes a per-namespace usage item into the `k8susage` vault, so the 1Password
      item title is the Kubernetes namespace. Each ExternalSecret contributes a
      single field to that item.
spec:
  background: true
  rules:
  - name: generate-usage-tracking-secret
    match:
      any:
      - resources:
          kinds:
          - external-secrets.io/v1/ExternalSecret
    preconditions:
      all:
      - key: "{{request.object.metadata.labels.\"kustomize.toolkit.fluxcd.io/name\" || ''}}"
        operator: NotEquals
        value: ""
    generate:
      generateExisting: true
      apiVersion: v1
      kind: Secret
      name: "{{request.object.metadata.name}}-usage-tracking"
      namespace: "{{request.object.metadata.namespace}}"
      synchronize: true
      data:
        type: Opaque
        stringData:
          # Value pushed to the secret store for usage tracking.
          # Keep it human-readable.
          tracking-value: "{{ request.object.metadata.namespace }}/{{ request.object.metadata.name }} (kustomization={{ request.object.metadata.labels.\"kustomize.toolkit.fluxcd.io/name\" }}, keys={{ request.object.spec.dataFrom[].extract.key }})"
    # We need this to run for existing ExternalSecrets too (background scan),
    # otherwise PushSecrets will fail with "could not get source secret".
    skipBackgroundRequests: false
  - name: generate-usage-tracking-pushsecret
    match:
      any:
      - resources:
          kinds:
          - external-secrets.io/v1/ExternalSecret
    preconditions:
      all:
      - key: "{{request.object.metadata.labels.\"kustomize.toolkit.fluxcd.io/name\" || ''}}"
        operator: NotEquals
        value: ""
    generate:
      generateExisting: true
      synchronize: true
      apiVersion: external-secrets.io/v1alpha1
      kind: PushSecret
      name: "{{request.object.metadata.name}}-usage-tracking"
      namespace: "{{request.object.metadata.namespace}}"
      data:
        spec:
          # Important: multiple PushSecrets will write fields into the same remoteKey (namespace item).
          # With `remoteRef.property` set, ESO will delete only the pushed property on cleanup
          # (so removing an ExternalSecret removes its field from the namespace item).
          deletionPolicy: Delete
          refreshInterval: 1h0m0s
          secretStoreRefs:
          - name: op-secret-store
            kind: ClusterSecretStore
          selector:
            secret:
              name: "{{request.object.metadata.name}}-usage-tracking"
          data:
          - match:
              secretKey: tracking-value
              remoteRef:
                # 1Password item title in the `k8susage` vault.
                remoteKey: "{{ request.object.metadata.namespace }}"
                # Unique field label within the item.
                property: "{{ request.object.metadata.name }}"
            # Provider-specific metadata (1Password Connect).
            # Adds tags to the resulting Item.
            metadata:
              apiVersion: kubernetes.external-secrets.io/v1alpha1
              kind: PushSecretMetadata
              spec:
                tags:
                - k8sUsage
                vault: k8susage
    # Allow background processing so the generated PushSecrets converge after policy updates.
    skipBackgroundRequests: false
