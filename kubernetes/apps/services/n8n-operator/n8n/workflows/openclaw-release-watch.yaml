---
apiVersion: v1
kind: ConfigMap
metadata:
  name: workflow-openclaw-release-watch
  namespace: services
data:
  workflow.json: |
    {
      "nodes": [
        {
          "parameters": {
            "pollTimes": {
              "item": [{"mode": "everyHour"}]
            },
            "feedUrl": "https://github.com/openclaw/openclaw/releases.atom"
          },
          "id": "rss-trigger",
          "name": "OpenClaw Release",
          "type": "n8n-nodes-base.rssFeedReadTrigger",
          "typeVersion": 1,
          "position": [0, 0]
        },
        {
          "parameters": {
            "url": "https://api.github.com/repos/MaudeCode/cove/releases/latest",
            "options": {
              "response": {"response": {"responseFormat": "json"}}
            }
          },
          "id": "fetch-cove",
          "name": "Fetch Cove Release",
          "type": "n8n-nodes-base.httpRequest",
          "typeVersion": 4.2,
          "position": [220, 0]
        },
        {
          "parameters": {
            "resource": "item",
            "operation": "getItemDetails",
            "vaultUUID": "3nk7dheikxygtpdqhyn2opawmy",
            "itemUUID": "323cfx7cvjxgh7kchngnuedjzm",
            "requestOptions": {}
          },
          "id": "get-token",
          "name": "Get Webhook Token",
          "type": "@n8layer/n8n-nodes-1password.onePassword",
          "typeVersion": 1,
          "position": [440, 0],
          "credentials": {
            "onePasswordApi": {
              "id": "",
              "name": "1Password Connect"
            }
          }
        },
        {
          "parameters": {
            "assignments": {
              "assignments": [
                {"id": "openclawVersion", "name": "openclawVersion", "value": "={{ $('OpenClaw Release').item.json.title.replace('OpenClaw ', '').replace('n8n@', '') }}", "type": "string"},
                {"id": "coveVersion", "name": "coveVersion", "value": "={{ $('Fetch Cove Release').item.json.tag_name.replace('v', '') }}", "type": "string"},
                {"id": "url", "name": "url", "value": "={{ $('OpenClaw Release').item.json.link }}", "type": "string"},
                {"id": "webhookToken", "name": "webhookToken", "value": "={{ $json.fields.find(f => f.label === 'token').value }}", "type": "string"}
              ]
            },
            "options": {}
          },
          "id": "extract-fields",
          "name": "Extract Versions",
          "type": "n8n-nodes-base.set",
          "typeVersion": 3.4,
          "position": [660, 0]
        },
        {
          "parameters": {
            "operation": "executeQuery",
            "query": "SELECT version FROM openclaw_notifications WHERE version = '{{ $json.openclawVersion }}' LIMIT 1",
            "options": {}
          },
          "id": "check-notified",
          "name": "Check If Notified",
          "type": "n8n-nodes-base.postgres",
          "typeVersion": 2.5,
          "position": [880, 0],
          "alwaysOutputData": true,
          "credentials": {
            "postgres": {
              "id": "",
              "name": "Postgres account"
            }
          }
        },
        {
          "parameters": {
            "conditions": {
              "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict"},
              "conditions": [{"id": "not-notified", "leftValue": "={{ $json.version }}", "rightValue": "", "operator": {"type": "string", "operation": "empty"}}],
              "combinator": "and"
            },
            "options": {}
          },
          "id": "filter-not-notified",
          "name": "Skip If Already Notified",
          "type": "n8n-nodes-base.filter",
          "typeVersion": 2,
          "position": [1100, 0]
        },
        {
          "parameters": {
            "conditions": {
              "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict"},
              "conditions": [{"id": "version-compare", "leftValue": "={{ $('Extract Versions').item.json.openclawVersion }}", "rightValue": "={{ $('Extract Versions').item.json.coveVersion }}", "operator": {"type": "string", "operation": "notEquals"}}],
              "combinator": "and"
            },
            "options": {}
          },
          "id": "filter-different",
          "name": "Filter If Different",
          "type": "n8n-nodes-base.filter",
          "typeVersion": 2,
          "position": [1320, 0]
        },
        {
          "parameters": {
            "method": "POST",
            "url": "http://10.0.10.95:18789/hooks/openclaw-release",
            "sendHeaders": true,
            "headerParameters": {
              "parameters": [{"name": "Authorization", "value": "=Bearer {{ $('Extract Versions').item.json.webhookToken }}"}]
            },
            "sendBody": true,
            "specifyBody": "json",
            "jsonBody": "={{ JSON.stringify({ version: $('Extract Versions').item.json.openclawVersion, url: $('Extract Versions').item.json.url }) }}",
            "options": {}
          },
          "id": "webhook-call",
          "name": "Notify OpenClaw",
          "type": "n8n-nodes-base.httpRequest",
          "typeVersion": 4.2,
          "position": [1540, 0]
        },
        {
          "parameters": {
            "operation": "executeQuery",
            "query": "INSERT INTO openclaw_notifications (version) VALUES ('{{ $('Extract Versions').item.json.openclawVersion }}') ON CONFLICT (version) DO NOTHING",
            "options": {}
          },
          "id": "mark-notified",
          "name": "Mark As Notified",
          "type": "n8n-nodes-base.postgres",
          "typeVersion": 2.5,
          "position": [1760, 0],
          "credentials": {
            "postgres": {
              "id": "",
              "name": "Postgres account"
            }
          }
        }
      ],
      "connections": {
        "OpenClaw Release": {"main": [[{"node": "Fetch Cove Release", "type": "main", "index": 0}]]},
        "Fetch Cove Release": {"main": [[{"node": "Get Webhook Token", "type": "main", "index": 0}]]},
        "Get Webhook Token": {"main": [[{"node": "Extract Versions", "type": "main", "index": 0}]]},
        "Extract Versions": {"main": [[{"node": "Check If Notified", "type": "main", "index": 0}]]},
        "Check If Notified": {"main": [[{"node": "Skip If Already Notified", "type": "main", "index": 0}]]},
        "Skip If Already Notified": {"main": [[{"node": "Filter If Different", "type": "main", "index": 0}]]},
        "Filter If Different": {"main": [[{"node": "Notify OpenClaw", "type": "main", "index": 0}]]},
        "Notify OpenClaw": {"main": [[{"node": "Mark As Notified", "type": "main", "index": 0}]]}
      },
      "settings": {
        "executionOrder": "v1"
      }
    }
---
apiVersion: n8n.n8n.io/v1alpha1
kind: N8nWorkflow
metadata:
  name: openclaw-release-watch
  namespace: services
spec:
  n8nInstance:
    serviceRef:
      name: n8n
      namespace: services
      port: 5678
    apiKeySecretRef:
      name: n8n-api-key
      key: api-key
  workflowName: "OpenClaw Release Watch"
  active: true
  deletionPolicy: Retain
  sourceRef:
    kind: ConfigMap
    name: workflow-openclaw-release-watch
    key: workflow.json
  credentialMappings:
    "Postgres account": postgres
